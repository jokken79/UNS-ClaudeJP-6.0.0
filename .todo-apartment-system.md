# APARTMENT SYSTEM V2.0 IMPLEMENTATION - COMPLETE TRACKER

## STATUS: ðŸš€ IN PROGRESS - PARALLEL COORDINATOR ACTIVATED

**Generated**: 2025-11-11
**Target**: Complete apartment management system with prorated rent, charges, and transfers
**Spec**: D:\UNS-ClaudeJP-5.4.1\docs\APARTAMENTOS_SISTEMA_COMPLETO_V2.md
**Working Directory**: D:\UNS-ClaudeJP-5.4.1

---

## PHASE 1: DATABASE FOUNDATION (CRITICAL - BLOCKS ALL OTHER WORK)

### 1.1 Add New Enums to models.py
- [ ] Add `RoomType` enum (1K, 1DK, 1LDK, 2K, 2DK, 2LDK, 3LDK, studio, other)
- [ ] Add `ApartmentStatus` enum (active, inactive, maintenance, reserved)
- [ ] Add `AssignmentStatus` enum (active, ended, cancelled, transferred)
- [ ] Add `ChargeType` enum (cleaning, repair, deposit, penalty, key_replacement, other)
- [ ] Add `DeductionStatus` enum (pending, processed, paid, cancelled)

### 1.2 Expand Apartment Model (15 new fields)
- [ ] Add `building_name: String(200)` - Building name
- [ ] Add `room_number: String(20)` - Room/unit number
- [ ] Add `floor_number: Integer` - Floor level
- [ ] Add `postal_code: String(10)` - Postal code
- [ ] Add `prefecture: String(50)` - Prefecture
- [ ] Add `city: String(100)` - City
- [ ] Add `address_line1: String(200)` - Address line 1
- [ ] Add `address_line2: String(200)` - Address line 2
- [ ] Add `room_type: RoomType` - Room type enum
- [ ] Add `size_sqm: Numeric(6,2)` - Size in square meters
- [ ] Add `base_rent: Integer NOT NULL` - Base monthly rent
- [ ] Add `management_fee: Integer DEFAULT 0` - Management fee
- [ ] Add `deposit: Integer DEFAULT 0` - Deposit (æ•·é‡‘)
- [ ] Add `key_money: Integer DEFAULT 0` - Key money (ç¤¼é‡‘)
- [ ] Add `default_cleaning_fee: Integer DEFAULT 20000` - Default cleaning charge

### 1.3 Add Landlord/Contract Fields to Apartment
- [ ] Add `contract_start_date: Date` - Contract start with landlord
- [ ] Add `contract_end_date: Date` - Contract end date
- [ ] Add `landlord_name: String(200)` - Landlord name
- [ ] Add `landlord_contact: String(200)` - Landlord contact
- [ ] Add `real_estate_agency: String(200)` - Real estate agency
- [ ] Add `emergency_contact: String(200)` - Emergency contact info

### 1.4 Update Apartment Status Fields
- [ ] Change `is_available: Boolean` to `status: ApartmentStatus`
- [ ] Update existing fields (notes, created_at, updated_at)

### 1.5 Create ApartmentAssignment Model (NEW TABLE)
- [ ] Add all fields per spec (id, apartment_id, employee_id, dates, rent calculations)
- [ ] Add constraints (CHECK dates, days_occupied)

### 1.6 Create AdditionalCharge Model (NEW TABLE)
- [ ] Add all fields per spec (id, assignment_id, employee_id, charge details)

### 1.7 Create RentDeduction Model (NEW TABLE)
- [ ] Add all fields per spec (id, assignment_id, employee_id, deduction details)
- [ ] Add UNIQUE constraint (assignment_id, year, month)

### 1.8 Add Relationships
- [ ] Apartment â†’ ApartmentAssignment (one-to-many)
- [ ] Employee â†’ ApartmentAssignment (one-to-many)
- [ ] ApartmentAssignment â†’ AdditionalCharge (one-to-many)
- [ ] ApartmentAssignment â†’ RentDeduction (one-to-many)

### 1.9 Generate and Execute Migration
- [ ] Generate Alembic migration
- [ ] Review migration file
- [ ] Execute migration
- [ ] Verify all 4 tables exist

### 1.10 Database Verification
- [ ] Query tables exist
- [ ] Test constraints work
- [ ] Insert sample data

---

## PHASE 2: SERVICE LAYER (Depends on Phase 1)

### 2.1 Assignment Service
- [ ] Create `assignment_service.py`
- [ ] Implement assignment CRUD
- [ ] Implement transfer logic
- [ ] Implement prorated calculation

### 2.2 Charge Service
- [ ] Create `charge_service.py`
- [ ] Implement charge CRUD
- [ ] Implement approval workflow

### 2.3 Deduction Service
- [ ] Create `deduction_service.py`
- [ ] Implement monthly generation
- [ ] Implement Excel export

### 2.4 Update Apartment Service
- [ ] Remove all TODOs
- [ ] Implement statistics calculation

---

## PHASE 3: API ENDPOINTS (Depends on Phase 2)

### 3.1 Assignment Endpoints
- [ ] POST /api/apartments/assignments
- [ ] GET /api/apartments/assignments
- [ ] PUT /api/apartments/assignments/{id}/end
- [ ] POST /api/apartments/assignments/transfer

### 3.2 Charge Endpoints
- [ ] POST /api/apartments/charges
- [ ] PUT /api/apartments/charges/{id}/approve

### 3.3 Deduction Endpoints
- [ ] GET /api/apartments/deductions/{year}/{month}
- [ ] POST /api/apartments/deductions/generate
- [ ] GET /api/apartments/deductions/export

---

## PHASE 4: FRONTEND (Can run parallel to Phase 2/3)

### 4.1 New Pages (7 pages needed)
- [ ] assignments/page.tsx - List all assignments
- [ ] assignments/[id]/end/page.tsx - End assignment form
- [ ] assignments/[id]/transfer/page.tsx - Transfer form
- [ ] charges/page.tsx - List charges
- [ ] charges/create/page.tsx - Add charge
- [ ] deductions/page.tsx - Monthly deductions
- [ ] Update existing 6 pages with new features

### 4.2 Components
- [ ] AssignmentCard
- [ ] ProratedCalculator
- [ ] ChargeList
- [ ] DeductionTable

---

## PHASE 5: TESTING (Depends on Phase 1-4)

### 5.1 Test All Workflows
- [ ] Assignment creation (full month)
- [ ] Assignment creation (prorated)
- [ ] Assignment end (prorated + cleaning)
- [ ] Transfer workflow
- [ ] Charge workflow
- [ ] Monthly deduction generation

### 5.2 Calculation Tests
- [ ] Test 30-day month
- [ ] Test 31-day month
- [ ] Test 28/29-day month
- [ ] Test rounding

---

## PHASE 6: DATA MIGRATION

- [ ] Migrate existing employee apartment data
- [ ] Create initial assignments
- [ ] Verify data consistency

---

## PROGRESS

**PHASE 1**: â¬œ 0/51 tasks (0%)
**PHASE 2**: â¬œ 0/35 tasks (0%)
**PHASE 3**: â¬œ 0/18 tasks (0%)
**PHASE 4**: â¬œ 0/35 tasks (0%)
**PHASE 5**: â¬œ 0/27 tasks (0%)
**PHASE 6**: â¬œ 0/6 tasks (0%)

**OVERALL**: 0/172 tasks (0%)

---

## NEXT ACTION

Starting Phase 1 with @database-architect immediately...
