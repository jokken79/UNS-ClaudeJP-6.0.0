# ========================================
# Apache JMeter Load Testing Setup
# ========================================
#
# Purpose: Automated load testing for UNS-ClaudeJP backend
# Usage: docker compose -f docker/load-test/docker-compose.yml up
#
# Author: Claude Code
# Created: 2025-11-12
# Version: 1.0.0
#
# ========================================

services:
  jmeter-master:
    image: justb4/jmeter:5.6.3
    container_name: uns-jmeter-master
    volumes:
      - ./test-plans:/tests
      - ./results:/results
      - ./reports:/reports
    environment:
      - JVM_ARGS=-Xms512m -Xmx2048m
    networks:
      - uns-loadtest
      - uns-claudejp_uns-network
    command: >
      sh -c "echo 'JMeter Master ready. Use docker exec to run tests.' && tail -f /dev/null"

  jmeter-slave-1:
    image: justb4/jmeter:5.6.3
    container_name: uns-jmeter-slave-1
    environment:
      - JVM_ARGS=-Xms512m -Xmx1024m
    networks:
      - uns-loadtest
    command: jmeter-server

  jmeter-slave-2:
    image: justb4/jmeter:5.6.3
    container_name: uns-jmeter-slave-2
    environment:
      - JVM_ARGS=-Xms512m -Xmx1024m
    networks:
      - uns-loadtest
    command: jmeter-server

  jmeter-slave-3:
    image: justb4/jmeter:5.6.3
    container_name: uns-jmeter-slave-3
    environment:
      - JVM_ARGS=-Xms512m -Xmx1024m
    networks:
      - uns-loadtest
    command: jmeter-server

  # Optional: InfluxDB for real-time metrics
  influxdb:
    image: influxdb:2.7-alpine
    container_name: uns-jmeter-influxdb
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=uns-kikaku
      - DOCKER_INFLUXDB_INIT_BUCKET=jmeter
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=jmeter-token-2025
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - uns-loadtest
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Grafana for visualizing JMeter metrics
  jmeter-grafana:
    image: grafana/grafana:11.2.0
    container_name: uns-jmeter-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3002:3000"
    volumes:
      - jmeter_grafana_data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana-datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - influxdb
    networks:
      - uns-loadtest
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  uns-loadtest:
    driver: bridge
  # Connect to main application network
  uns-claudejp_uns-network:
    external: true

volumes:
  influxdb_data:
    driver: local
  jmeter_grafana_data:
    driver: local
