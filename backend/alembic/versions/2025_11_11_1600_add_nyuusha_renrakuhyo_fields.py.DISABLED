"""Add candidate_id and employee_data to requests for 入社連絡票 (nyuusha renrakuhyo)

Revision ID: add_nyuusha_fields
Revises: add_photo_sync_trigger
Create Date: 2025-11-11 16:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'add_nyuusha_fields'
down_revision = 'add_photo_sync_trigger'
branch_labels = None
depends_on = None


def upgrade() -> None:
    """
    Add support for 入社連絡票 (New Hire Notification Form) workflow:

    1. Add candidate_id to link requests to candidates
    2. Add employee_data JSONB to store employee-specific data before approval
    3. Create index for performance
    4. Add foreign key constraint

    This enables the workflow:
    Candidate approved → Auto-create 入社連絡票 request → Fill employee data → Approve → Create employee
    """

    # Add candidate_id column (nullable for backward compatibility)
    op.add_column('requests',
        sa.Column('candidate_id', sa.Integer(), nullable=True,
                  comment='Foreign key to candidates table for 入社連絡票')
    )

    # Add employee_data JSONB column to store employee-specific data
    op.add_column('requests',
        sa.Column('employee_data', postgresql.JSONB(), nullable=True,
                  comment='JSON data for employee fields (factory_id, jikyu, position, etc.)')
    )

    # Create foreign key constraint
    op.create_foreign_key(
        'fk_requests_candidate_id',
        'requests', 'candidates',
        ['candidate_id'], ['id'],
        ondelete='SET NULL'  # If candidate is deleted, don't delete the request
    )

    # Create index for performance (lookup requests by candidate)
    op.create_index(
        'idx_requests_candidate_id',
        'requests',
        ['candidate_id']
    )


def downgrade() -> None:
    """
    Revert the 入社連絡票 support changes
    """

    # Drop index
    op.drop_index('idx_requests_candidate_id', table_name='requests')

    # Drop foreign key constraint
    op.drop_constraint('fk_requests_candidate_id', 'requests', type_='foreignkey')

    # Drop columns
    op.drop_column('requests', 'employee_data')
    op.drop_column('requests', 'candidate_id')
