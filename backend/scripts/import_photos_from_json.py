#!/usr/bin/env python3
"""
Import photos from access_photo_mappings.json to PostgreSQL

This script:
1. Reads access_photo_mappings.json (rirekisho_id â†’ photo base64)
2. Updates candidates.photo_data_url in PostgreSQL
3. Reports statistics

Usage:
    python scripts/import_photos_from_json.py

Requirements:
    - access_photo_mappings.json must exist at /app/access_photo_mappings.json
    - PostgreSQL must be running with candidates table populated
"""

import sys
import json
from pathlib import Path
from datetime import datetime

sys.path.insert(0, '/app')

from app.core.database import SessionLocal
from app.models.models import Candidate

def import_photos_from_json():
    """Import photos from JSON mapping file"""

    json_file = Path('/app/access_photo_mappings.json')

    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          IMPORTING PHOTOS FROM JSON MAPPING                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    # Check if JSON file exists
    if not json_file.exists():
        print(f"""
âŒ ERROR: access_photo_mappings.json NOT FOUND

Expected location: {json_file}

This file should have been generated by:
- scripts/BUSCAR_FOTOS_AUTO.bat (Windows)
- backend/scripts/auto_extract_photos_from_databasejp.py

Please:
1. Run BUSCAR_FOTOS_AUTO.bat to generate the JSON file
   OR
2. Copy it manually to the container:
   docker cp access_photo_mappings.json uns-claudejp-backend:/app/

3. Run this script again

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NOTA: El sistema funciona perfectamente SIN fotos.
      Este paso es opcional.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
        return False

    # Read JSON mapping
    print(f"ğŸ“‚ Reading JSON file: {json_file}")
    try:
        with open(json_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
            # Extract mappings from the data structure
            photo_mappings = data.get('mappings', {}) if isinstance(data, dict) else data
    except json.JSONDecodeError as e:
        print(f"""
âŒ ERROR: Invalid JSON format

Error: {str(e)}

The file might be corrupted. Please regenerate it using
BUSCAR_FOTOS_AUTO.bat
""")
        return False
    except Exception as e:
        print(f"âŒ ERROR reading JSON: {str(e)}")
        return False

    print(f"âœ“ Loaded {len(photo_mappings):,} photo mappings")

    # Show sample
    if photo_mappings:
        sample_id = list(photo_mappings.keys())[0]
        sample_data = photo_mappings[sample_id]
        data_preview = sample_data[:50] + "..." if len(sample_data) > 50 else sample_data
        print(f"  Sample: {sample_id} â†’ {data_preview}")
    print()

    # Connect to database
    print("ğŸ“Š Connecting to PostgreSQL...")
    db = SessionLocal()

    try:
        # Get all candidates
        candidates = db.query(Candidate).all()
        total_candidates = len(candidates)
        print(f"âœ“ Found {total_candidates:,} candidates in database\n")

        if total_candidates == 0:
            print("""
âš ï¸  WARNING: No candidates found in database

Please ensure that candidates have been imported first using:
- import_candidates_improved.py

Then run this script again.
""")
            return False

        # Import photos
        print("=" * 60)
        print("  IMPORTING PHOTOS TO POSTGRESQL")
        print("=" * 60)
        print()

        updated = 0
        skipped = 0
        errors = 0
        start_time = datetime.now()

        for candidate in candidates:
            rirekisho_id = str(candidate.rirekisho_id)

            if rirekisho_id in photo_mappings:
                try:
                    photo_data = photo_mappings[rirekisho_id]

                    # Validate photo data format
                    if not isinstance(photo_data, str):
                        print(f"  âš ï¸  Invalid data type for {rirekisho_id}: {type(photo_data)}")
                        errors += 1
                        continue

                    if not photo_data.startswith('data:image/'):
                        print(f"  âš ï¸  Invalid photo format for {rirekisho_id}")
                        print(f"      Expected: data:image/...")
                        print(f"      Got: {photo_data[:30]}...")
                        errors += 1
                        continue

                    # Update candidate
                    candidate.photo_data_url = photo_data
                    db.commit()
                    updated += 1

                    # Progress indicator every 100 photos
                    if updated % 100 == 0:
                        elapsed = (datetime.now() - start_time).total_seconds()
                        rate = updated / elapsed if elapsed > 0 else 0
                        remaining = (total_candidates - updated) / rate if rate > 0 else 0
                        print(f"  âœ“ {updated:,}/{total_candidates:,} photos imported "
                              f"({updated/total_candidates*100:.1f}%) "
                              f"- {rate:.1f} photos/sec "
                              f"- ETA: {int(remaining)}s")

                except Exception as e:
                    db.rollback()
                    print(f"  âŒ Error for rirekisho_id {rirekisho_id}: {str(e)[:50]}")
                    errors += 1
            else:
                skipped += 1

        # Final stats
        elapsed = (datetime.now() - start_time).total_seconds()

        print()
        print("=" * 60)
        print("  IMPORT COMPLETED")
        print("=" * 60)
        print()
        print(f"ğŸ“Š Summary:")
        print(f"  âœ“ Photos imported:     {updated:,}")
        print(f"  âš ï¸  Skipped (no photo):  {skipped:,}")
        print(f"  âŒ Errors:             {errors:,}")
        print(f"  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print(f"  ğŸ“ˆ Total candidates:   {total_candidates:,}")
        print(f"  ğŸ“¸ Coverage:           {updated/total_candidates*100:.1f}%")
        print(f"  â±ï¸  Time elapsed:       {int(elapsed)}s ({elapsed/60:.1f} minutes)")
        if updated > 0:
            print(f"  âš¡ Import rate:        {updated/elapsed:.1f} photos/sec")
        print()

        if errors > 0:
            print("âš ï¸  WARNING: Some photos failed to import")
            print("   Check the error messages above for details")
            print()

        if skipped > 0:
            print(f"â„¹ï¸  INFO: {skipped:,} candidates without photos in mapping")
            print("   This is normal if not all candidates have photos")
            print()

        if updated > 0:
            print("âœ… Photos successfully imported to PostgreSQL!")
            print()
            print("   Verify in database:")
            print("   SELECT COUNT(*) FROM candidates WHERE photo_data_url IS NOT NULL;")
            print(f"   Expected result: {updated:,}")
            print()

        return True

    except Exception as e:
        print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ERROR DURING IMPORT                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error: {str(e)}

Stack trace:
""")
        import traceback
        traceback.print_exc()
        return False

    finally:
        db.close()

if __name__ == '__main__':
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    UNS-ClaudeJP 5.2 - Photo Import from JSON              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    success = import_photos_from_json()

    if success:
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    âœ… IMPORT SUCCESSFUL                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
        sys.exit(0)
    else:
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    âš ï¸  IMPORT FAILED OR SKIPPED                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El sistema funciona perfectamente sin fotos.
Las fotos se pueden agregar manualmente despuÃ©s.
""")
        sys.exit(1)
