â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ANÃLISIS DE SEGURIDAD: AUTENTICACIÃ“N Y RBAC - RESUMEN EJECUTIVO      â•‘
â•‘                           UNS-ClaudeJP 5.4.1                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ESTADO GENERAL                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CrÃ­ticos:      4 problemas                                                  â”‚
â”‚ Altos:         4 problemas                                                  â”‚
â”‚ Medios:        4 problemas                                                  â”‚
â”‚ PuntuaciÃ³n:    5.2/10 (Requiere atenciÃ³n urgente)                          â”‚
â”‚ RecomendaciÃ³n: FIX CRÃTICOS antes de usar en producciÃ³n                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. HALLAZGOS CRÃTICOS (URGENTES)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ ğŸ”´ AUTH-001: DEV TOKEN BYPASS                                              â”‚
â”‚    UbicaciÃ³n: backend/app/services/auth_service.py (lÃ­neas 451-455)        â”‚
â”‚    Problema: Token "dev-admin-token-*" bypassa autenticaciÃ³n en dev        â”‚
â”‚    Impacto:  Acceso no autorizado a endpoints protegidos                   â”‚
â”‚    AcciÃ³n:   ELIMINAR CÃ“DIGO INMEDIATAMENTE                                â”‚
â”‚                                                                              â”‚
â”‚ ğŸ”´ AUTH-002: DOBLE ALMACENAMIENTO DE TOKENS                                â”‚
â”‚    UbicaciÃ³n: auth.py (lÃ­neas 138-143) + auth-store.ts (lÃ­nea 89)         â”‚
â”‚    Problema: Token en cookies + localStorage crea riesgo XSS               â”‚
â”‚    Impacto:  XSS puede robar token del localStorage                        â”‚
â”‚    AcciÃ³n:   Usar SOLO HttpOnly cookies (no localStorage)                  â”‚
â”‚                                                                              â”‚
â”‚ ğŸ”´ AUTH-003: ROLES LEGACY SIN INTEGRACIÃ“N                                  â”‚
â”‚    UbicaciÃ³n: models.py (lÃ­neas 24-25)                                     â”‚
â”‚    Problema: KEITOSAN, TANTOSHA no estÃ¡n en jerarquÃ­a principal            â”‚
â”‚    Impacto:  Inconsistencia en validaciÃ³n de permisos                      â”‚
â”‚    AcciÃ³n:   Integrar en require_role() o deprecar                         â”‚
â”‚                                                                              â”‚
â”‚ ğŸ”´ AUTH-004: DIRECT ROLE COMPARISONS                                       â”‚
â”‚    UbicaciÃ³n: MÃºltiples archivos (apartments_v2.py, employees.py, etc.)   â”‚
â”‚    Problema: Comparaciones de rol sin usar require_role()                  â”‚
â”‚    Impacto:  Inconsistencia y posibles bypasses                            â”‚
â”‚    AcciÃ³n:   Reemplazar con require_role() centralizado                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. HALLAZGOS ALTOS (IMPORTANTE)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ ğŸŸ  AUTH-005: REGISTRO ABIERTO SIN VALIDACIÃ“N                               â”‚
â”‚    Endpoint:  POST /api/auth/register                                      â”‚
â”‚    Problema:  Permite registro sin restricciones ni validaciÃ³n              â”‚
â”‚    Impacto:   Spam, cuentas maliciosas, abuso                              â”‚
â”‚    AcciÃ³n:    Agregar validaciÃ³n de contraseÃ±a + email verification        â”‚
â”‚                                                                              â”‚
â”‚ ğŸŸ  AUTH-006: RATE LIMIT DÃ‰BIL EN LOGIN                                     â”‚
â”‚    LÃ­mite:    5/minuto = 7200 intentos/dÃ­a                                 â”‚
â”‚    Problema:  Vulnerable a fuerza bruta                                    â”‚
â”‚    Impacto:   Posibilidad de comprometer cuentas dÃ©biles                   â”‚
â”‚    AcciÃ³n:    Aumentar a 2-3/minuto, agregar cuenta de intentos fallidos   â”‚
â”‚                                                                              â”‚
â”‚ ğŸŸ  AUTH-007: ROLES LEGACY NO EN HIERARCHY                                  â”‚
â”‚    Roles:     KEITOSAN (finance), TANTOSHA (HR)                            â”‚
â”‚    Problema:  No se pueden comparar en require_role()                      â”‚
â”‚    Impacto:   Permisos inconsistentes entre usuarios legacy y nuevos       â”‚
â”‚    AcciÃ³n:    Documentar, deprecar, o integrar formalmente                 â”‚
â”‚                                                                              â”‚
â”‚ ğŸŸ  AUTH-008: require_admin() SIMPLIFICADO                                  â”‚
â”‚    UbicaciÃ³n: deps.py (lÃ­neas 30-41)                                       â”‚
â”‚    Problema:  Solo compara strings, no utiliza enums                       â”‚
â”‚    Impacto:   Diferente de require_role("admin")                           â”‚
â”‚    AcciÃ³n:    Unificar con require_role() o usar enums                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. MATRIZ DE ROLES Y JERARQUÃA                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ Nivel 0: SUPER_ADMIN        - Control total del sistema                   â”‚
â”‚ Nivel 1: ADMIN              - AdministraciÃ³n casi completa                 â”‚
â”‚ Nivel 2: COORDINATOR        - CoordinaciÃ³n de recursos                    â”‚
â”‚ Nivel 3: KANRININSHA        - Gerencia de oficina/HR                      â”‚
â”‚ Nivel 4: EMPLOYEE           - Empleado estÃ¡ndar                           â”‚
â”‚ Nivel 5: CONTRACT_WORKER    - Trabajador por contrato                     â”‚
â”‚                                                                              â”‚
â”‚ Legacy:  KEITOSAN           - Finanzas (no integrado)                      â”‚
â”‚ Legacy:  TANTOSHA           - RR.HH. (no integrado)                        â”‚
â”‚                                                                              â”‚
â”‚ Total:   8 roles (6 estÃ¡ndar + 2 legacy)                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ENDPOINTS DE AUTENTICACIÃ“N                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ ABIERTOS (Sin protecciÃ³n):                                                  â”‚
â”‚   POST   /api/auth/register             (3/hora rate limit)                â”‚
â”‚   POST   /api/auth/login                (5/min rate limit) âš ï¸ DÃ‰BIL       â”‚
â”‚   POST   /api/auth/refresh              (10/min rate limit)                â”‚
â”‚   GET    /                              (root endpoint)                     â”‚
â”‚   GET    /api/health                    (health check)                      â”‚
â”‚                                                                              â”‚
â”‚ PROTEGIDOS (Requieren autenticaciÃ³n):                                       â”‚
â”‚   GET    /api/auth/me                   âœ“ OK                              â”‚
â”‚   PUT    /api/auth/me                   âœ“ OK                              â”‚
â”‚   POST   /api/auth/change-password      âœ“ OK                              â”‚
â”‚   POST   /api/auth/logout               âœ“ OK                              â”‚
â”‚                                                                              â”‚
â”‚ PROTEGIDOS (Requieren admin):                                               â”‚
â”‚   GET    /api/auth/users                âœ“ require_role("admin")           â”‚
â”‚                                                                              â”‚
â”‚ PROTEGIDOS (Requieren super_admin):                                         â”‚
â”‚   DELETE /api/auth/users/{id}           âœ“ require_role("super_admin")     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. FLUJO DE AUTENTICACIÃ“N                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ Login:                                                                       â”‚
â”‚   1. POST /api/auth/login {username, password}                             â”‚
â”‚   2. Backend verifica con bcrypt                                           â”‚
â”‚   3. Genera access_token (8 horas)                                         â”‚
â”‚   4. Genera refresh_token (30 dÃ­as, guardado en DB)                        â”‚
â”‚   5. Retorna en JSON + HttpOnly cookies                                    â”‚
â”‚                                                                              â”‚
â”‚ Requests Posteriores:                                                       â”‚
â”‚   1. Frontend envÃ­a token en:                                               â”‚
â”‚      - Authorization header: "Bearer {token}"                              â”‚
â”‚      - O HttpOnly cookie                                                    â”‚
â”‚   2. Backend valida JWT (firma, expiraciÃ³n, issuer, audience)              â”‚
â”‚   3. Busca usuario en DB                                                   â”‚
â”‚   4. Verifica is_active = True                                             â”‚
â”‚   5. Ejecuta endpoint                                                       â”‚
â”‚                                                                              â”‚
â”‚ Refresh:                                                                     â”‚
â”‚   1. POST /api/auth/refresh {refresh_token}                                â”‚
â”‚   2. Backend verifica refresh_token en DB                                  â”‚
â”‚   3. Revoca token viejo                                                    â”‚
â”‚   4. Genera nuevo access_token y refresh_token                             â”‚
â”‚   5. Token rotation (ambos renovados)                                       â”‚
â”‚                                                                              â”‚
â”‚ Logout:                                                                      â”‚
â”‚   1. POST /api/auth/logout {refresh_token}                                 â”‚
â”‚   2. Backend marca refresh_token como revocado                             â”‚
â”‚   3. Limpia cookies                                                        â”‚
â”‚   4. Usuario debe volver a hacer login                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. VERIFICACIÃ“N DE SEGURIDAD (CHECKLIST)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ JWT & TOKENS                                                                 â”‚
â”‚   âœ“ Algoritmo seguro (HS256)                                               â”‚
â”‚   âœ“ Claims completos (exp, iat, iss, aud, jti)                             â”‚
â”‚   âœ“ VerificaciÃ³n de firma                                                  â”‚
â”‚   âœ“ VerificaciÃ³n de expiraciÃ³n                                             â”‚
â”‚   âœ“ Refresh token en DB para revocaciÃ³n                                    â”‚
â”‚   âœ“ Token rotation (token anterior se revoca)                              â”‚
â”‚   âœ— Dev token bypass activo                                                â”‚
â”‚   âœ— Doble almacenamiento (localStorage + cookie)                           â”‚
â”‚   âœ— Sin MFA/2FA                                                            â”‚
â”‚                                                                              â”‚
â”‚ CONTRASEÃ‘AS                                                                  â”‚
â”‚   âœ“ Hash bcrypt (resistente a fuerza bruta)                                â”‚
â”‚   âœ“ VerificaciÃ³n segura (timing attack resistant)                          â”‚
â”‚   âœ“ Cambio de contraseÃ±a disponible                                        â”‚
â”‚   âœ— Registro sin validaciÃ³n de fortaleza                                    â”‚
â”‚   âœ— Sin requisitos mÃ­nimos de complejidad                                   â”‚
â”‚                                                                              â”‚
â”‚ ROLES Y PERMISOS                                                             â”‚
â”‚   âœ“ JerarquÃ­a clara (6 roles)                                              â”‚
â”‚   âœ“ RBAC en base de datos                                                  â”‚
â”‚   âœ“ Endpoints protegidos con require_role()                                â”‚
â”‚   âœ“ AuditorÃ­a de tokens (user_agent, ip_address)                           â”‚
â”‚   âœ“ 54 pÃ¡ginas con control granular                                        â”‚
â”‚   âœ— Roles legacy sin integraciÃ³n                                           â”‚
â”‚   âœ— Direct role checks en algunos endpoints                                â”‚
â”‚   âœ— Inconsistencia string vs enum                                          â”‚
â”‚   âœ— Permisos DB vs hardcoded pueden desincronizarse                        â”‚
â”‚                                                                              â”‚
â”‚ ENDPOINTS                                                                    â”‚
â”‚   âœ“ Rate limiting en login y registro                                      â”‚
â”‚   âœ“ Logout revoca refresh tokens                                           â”‚
â”‚   âœ“ Logout from all devices disponible                                     â”‚
â”‚   âœ“ Health check sin autenticaciÃ³n (normal)                                â”‚
â”‚   âœ— Registro abierto sin validaciÃ³n                                        â”‚
â”‚   âœ— Rate limit dÃ©bil (5/min = 7200/dÃ­a)                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. PLAN DE CORRECCIÃ“N (PRIORIDAD)                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ INMEDIATO (Hoy):                                                             â”‚
â”‚   [ ] Eliminar dev token bypass (auth_service.py:451-455)                  â”‚
â”‚   [ ] Remover token de localStorage (guardar solo en cookies)              â”‚
â”‚   [ ] Documentar roles legacy y su estado                                  â”‚
â”‚                                                                              â”‚
â”‚ CORTO PLAZO (Esta semana):                                                  â”‚
â”‚   [ ] Unificar validaciÃ³n de roles (usar require_role)                     â”‚
â”‚   [ ] Aumentar rate limit login a 2-3/minuto                               â”‚
â”‚   [ ] Agregar validaciÃ³n de contraseÃ±a en registro                         â”‚
â”‚   [ ] Agregar email verification                                           â”‚
â”‚                                                                              â”‚
â”‚ MEDIANO PLAZO (Este mes):                                                   â”‚
â”‚   [ ] Integrar roles legacy en jerarquÃ­a                                    â”‚
â”‚   [ ] Sincronizar permisos DB vs hardcoded                                  â”‚
â”‚   [ ] Agregar audit log de autenticaciÃ³n                                   â”‚
â”‚   [ ] Implementar MFA/2FA                                                  â”‚
â”‚                                                                              â”‚
â”‚ LARGO PLAZO (Este trimestre):                                               â”‚
â”‚   [ ] OAuth2 integraciÃ³n                                                    â”‚
â”‚   [ ] Session management mejorado                                          â”‚
â”‚   [ ] AnÃ¡lisis de seguridad profundo                                       â”‚
â”‚   [ ] Penetration testing                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ARCHIVOS CLAVE A REVISAR                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ CrÃ­ticos:                                                                    â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/services/auth_service.py      â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/auth.py                   â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/frontend/stores/auth-store.ts              â”‚
â”‚                                                                              â”‚
â”‚ Importantes:                                                                 â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/role_permissions.py        â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/models/models.py               â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/deps.py                    â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/frontend/lib/api.ts                        â”‚
â”‚                                                                              â”‚
â”‚ Por Revisar:                                                                 â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/apartments_v2.py           â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/employees.py               â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/salary.py                  â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/timer_cards.py             â”‚
â”‚   /home/user/UNS-ClaudeJP-5.4.1/backend/app/api/yukyu.py                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONCLUSIÃ“N: El sistema tiene una arquitectura de autenticaciÃ³n sÃ³lida con JWT,
bcrypt y RBAC, pero presenta vulnerabilidades crÃ­ticas (dev token bypass, 
doble almacenamiento de tokens) e inconsistencias (roles legacy, direct checks,
string vs enum). Requiere correcciones URGENTES antes de usar en producciÃ³n.

AnÃ¡lisis completo: /home/user/UNS-ClaudeJP-5.4.1/docs/auth_security_analysis.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
