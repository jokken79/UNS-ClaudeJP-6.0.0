# üêõ Bug Fixes - 13 de Noviembre 2025

## Resumen
Se identificaron y corrigieron bugs cr√≠ticos en los sistemas de Yukyu y Apartamentos.

---

## ‚úÖ Bug #1: Ruta incorrecta de Apartments V2 API (CORREGIDO)

### Descripci√≥n del Problema
La p√°gina `/apartments` mostraba errores 404 en todas las llamadas API porque:
- **Backend** registraba el router en `/api/apartments`
- **Frontend** intentaba llamar a `/apartments-v2/apartments`

### Causa Ra√≠z
Inconsistencia entre la configuraci√≥n del router en `backend/app/main.py` y las llamadas del servicio en `frontend/lib/api.ts`.

### Soluci√≥n Aplicada
**Archivo modificado:** `backend/app/main.py:268`

**Antes:**
```python
app.include_router(apartments_v2.router, prefix="/api/apartments", tags=["Apartments"])
```

**Despu√©s:**
```python
app.include_router(apartments_v2.router, prefix="/api/apartments-v2", tags=["Apartments V2"])
```

### Commit
```
commit 2af6e5e
fix(backend): Correct apartments-v2 API route from /api/apartments to /api/apartments-v2
```

### Resultado
‚úÖ Ahora el frontend y backend usan la misma ruta: `/api/apartments-v2`
‚úÖ La p√°gina `/apartments` cargar√° correctamente
‚úÖ Todas las funcionalidades de apartamentos funcionar√°n (lista, crear, editar, asignaciones, reportes)

---

## ‚ö†Ô∏è Bug #2: Error en /admin/yukyu-management (REQUIERE VERIFICACI√ìN)

### Estado Actual
**C√≥digo verificado:** ‚úÖ Todo el c√≥digo est√° correcto
- ‚úÖ P√°gina existe: `frontend/app/(dashboard)/admin/yukyu-management/page.tsx`
- ‚úÖ Componente DevModeAlert existe y exporta correctamente
- ‚úÖ Backend endpoints funcionan:
  - `/api/yukyu/balances/calculate`
  - `/api/yukyu/maintenance/scheduler-status`
  - `/api/yukyu/maintenance/expire-old-yukyus`
- ‚úÖ Funci√≥n `get_scheduler_status` existe en `backend/app/core/scheduler.py`

### Posibles Causas del Error
Como Docker no estaba corriendo al momento del an√°lisis, el error puede ser:

1. **Servicios no iniciados** - Backend/Frontend no est√°n corriendo
2. **Error de autenticaci√≥n** - Token JWT expirado o inv√°lido
3. **Permisos insuficientes** - Usuario sin rol ADMIN o SUPER_ADMIN
4. **Error de base de datos** - Conexi√≥n a PostgreSQL fallida

### C√≥mo Verificar y Solucionar

#### Paso 1: Arrancar Servicios
```bash
# En tu m√°quina Windows
cd scripts
START.bat

# Esperar a que todos los servicios est√©n healthy
# Verificar logs
LOGS.bat
```

#### Paso 2: Verificar Backend
```bash
# Abrir navegador en:
http://localhost:8000/api/docs

# Buscar endpoints:
- GET /api/yukyu/maintenance/scheduler-status
- POST /api/yukyu/balances/calculate
- POST /api/yukyu/maintenance/expire-old-yukyus

# Intentar ejecutarlos desde Swagger UI
```

#### Paso 3: Verificar Frontend
```bash
# Abrir navegador en:
http://localhost:3000/admin/yukyu-management

# Abrir Chrome DevTools (F12)
# Ver pesta√±a Console para errores JavaScript
# Ver pesta√±a Network para errores de API (404, 401, 500, etc.)
```

#### Paso 4: Verificar Autenticaci√≥n
```bash
# En el navegador (F12 > Console):
localStorage.getItem('auth-storage')

# Debe devolver un objeto con:
# - token: "eyJ..."
# - user: { id, username, role }

# Si no hay token o expir√≥:
# 1. Logout
# 2. Login nuevamente con admin/admin123
# 3. Intentar acceder a la p√°gina
```

### Soluciones Probables

**Si ves error 401 (Unauthorized):**
```
Soluci√≥n: Re-login con credenciales de admin
```

**Si ves error 403 (Forbidden):**
```
Soluci√≥n: Tu usuario no tiene rol ADMIN o SUPER_ADMIN
Verificar en: http://localhost:8000/api/users/me
```

**Si ves error 404 (Not Found):**
```
Soluci√≥n: Backend no est√° corriendo o rutas mal configuradas
Verificar: http://localhost:8000/api/docs
```

**Si ves error 500 (Internal Server Error):**
```
Soluci√≥n: Error en backend, revisar logs
Comando: docker compose logs backend --tail=100
```

**Si componente no se renderiza:**
```
Soluci√≥n: Error de compilaci√≥n en frontend
Comando: docker compose logs frontend --tail=100
```

---

## üìã Checklist de Verificaci√≥n

### Antes de Probar
- [ ] Docker Desktop est√° corriendo
- [ ] Ejecutar `START.bat` y esperar 2-3 minutos
- [ ] Verificar servicios con `docker compose ps` (todos deben estar "healthy")

### Probar /apartments
- [ ] Abrir http://localhost:3000/apartments
- [ ] Debe mostrar lista de apartamentos con estad√≠sticas
- [ ] Filtros deben funcionar (buscar, disponible, prefectura, etc.)
- [ ] Bot√≥n "Nuevo Apartamento" debe funcionar
- [ ] Click en apartamento debe abrir detalles
- [ ] No debe haber errores en consola (F12)

### Probar /admin/yukyu-management
- [ ] Login como admin (admin/admin123)
- [ ] Abrir http://localhost:3000/admin/yukyu-management
- [ ] Debe mostrar 4 tarjetas de estad√≠sticas
- [ ] Selector de empleado debe cargar lista
- [ ] B√∫squeda de empleado debe funcionar
- [ ] Bot√≥n "Calcular Yukyus" debe funcionar
- [ ] Estado del Scheduler debe mostrarse
- [ ] No debe haber errores en consola (F12)

---

## üöÄ Pr√≥ximos Pasos

1. **Probar las correcciones**
   - Arrancar Docker con `START.bat`
   - Probar ambas p√°ginas seg√∫n checklist
   - Reportar cualquier error que persista

2. **Nuevas funcionalidades**
   - Una vez verificado que todo funciona
   - Definir qu√© funcionalidades espec√≠ficas agregar
   - Opciones sugeridas en conversaci√≥n anterior

---

## üìä Resumen de Cambios

### Archivos Modificados
- `backend/app/main.py` - Corregida ruta de apartments-v2

### Archivos Verificados (Sin Cambios)
- `frontend/app/(dashboard)/admin/yukyu-management/page.tsx` ‚úÖ
- `frontend/components/dev-mode-alert.tsx` ‚úÖ
- `frontend/lib/api.ts` ‚úÖ
- `backend/app/api/yukyu.py` ‚úÖ
- `backend/app/core/scheduler.py` ‚úÖ

### Branch
```
claude/memory-conversation-check-011CV5Zt4vUYpJQnmWiYujjY
```

### Commits
```
2af6e5e - fix(backend): Correct apartments-v2 API route
```

---

## üí° Notas Importantes

1. **Apartamentos est√° en V2**: S√≠, la p√°gina `/apartments` usa la API V2 (`apartmentsV2Service` de `frontend/lib/api.ts`)

2. **El c√≥digo est√° correcto**: Ambas p√°ginas tienen c√≥digo funcional. El error reportado probablemente se debe a servicios no iniciados.

3. **Verificaci√≥n local necesaria**: Como no puedo arrancar Docker en este entorno, necesitas probar en tu m√°quina Windows.

4. **Memoria completa**: S√≠, tengo registro completo del trabajo de ayer sobre yukyus y apartamentos (ver an√°lisis exhaustivo en conversaci√≥n).

---

**Fecha:** 13 de Noviembre 2025
**Claude Session:** claude/memory-conversation-check-011CV5Zt4vUYpJQnmWiYujjY
**Status:** 1 bug corregido ‚úÖ | 1 bug pendiente de verificaci√≥n ‚ö†Ô∏è
