# CRITICAL FLOWS - How The App Actually Works

> **For AI agents**: Understanding these flows will help you fix issues in context.

---

## ğŸ” AUTHENTICATION FLOW (Complete)

### User Login â†’ JWT Token â†’ Protected Endpoint

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER OPENS BROWSER â†’ Frontend at http://localhost:3000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: User enters username/password â†’ clicks "Login"           â”‚
â”‚ File: frontend/app/(dashboard)/login/page.tsx                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Sends POST request                                       â”‚
â”‚ Request to: http://localhost:8000/api/auth/login                  â”‚
â”‚ Body: { "username": "admin", "password": "admin123" }             â”‚
â”‚ File: frontend/lib/api.ts (axios instance)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Route handler receives request                           â”‚
â”‚ File: backend/app/api/auth.py â†’ @router.post("/login")           â”‚
â”‚ 1. Validate request body with LoginSchema                          â”‚
â”‚ 2. Query users table: SELECT * FROM users WHERE username='admin'  â”‚
â”‚ 3. Hash input password & compare with stored hash                 â”‚
â”‚    File: backend/app/core/security.py â†’ verify_password()         â”‚
â”‚ 4. If wrong password: raise HTTPException(401)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Generate JWT token                                       â”‚
â”‚ File: backend/app/core/security.py â†’ create_access_token()       â”‚
â”‚ Token contents:                                                    â”‚
â”‚ {                                                                  â”‚
â”‚   "sub": "admin",           â† username                            â”‚
â”‚   "exp": 1699999999,        â† expiration time (1 hour later)      â”‚
â”‚   "iat": 1699996399,        â† issued at                           â”‚
â”‚   "role": "ADMIN"           â† user role                           â”‚
â”‚ }                                                                  â”‚
â”‚ Token signed with: SECRET_KEY from .env                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Return response to frontend                              â”‚
â”‚ Response:                                                          â”‚
â”‚ {                                                                  â”‚
â”‚   "access_token": "eyJhbGciOi...",  â† JWT token                  â”‚
â”‚   "token_type": "bearer",                                         â”‚
â”‚   "user": { "id": 1, "username": "admin", "role": "ADMIN" }      â”‚
â”‚ }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Receive JWT token                                       â”‚
â”‚ 1. Save token to localStorage                                    â”‚
â”‚    localStorage.setItem('token', 'eyJhbGciOi...')               â”‚
â”‚ 2. Save user info to Zustand store                               â”‚
â”‚    File: frontend/stores/auth.ts                                  â”‚
â”‚ 3. Redirect to /dashboard                                        â”‚
â”‚ File: frontend/contexts/auth.tsx â†’ useAuth()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Now make authenticated requests                         â”‚
â”‚ Every API call includes JWT in header:                            â”‚
â”‚ GET /api/candidates/                                              â”‚
â”‚ Headers: {                                                         â”‚
â”‚   "Authorization": "Bearer eyJhbGciOi..."  â† Token from storage   â”‚
â”‚ }                                                                  â”‚
â”‚ File: frontend/lib/api.ts â†’ axios interceptor                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Validate JWT token on protected endpoint                â”‚
â”‚ 1. Extract token from Authorization header                        â”‚
â”‚ 2. Verify token signature with SECRET_KEY                        â”‚
â”‚ 3. Check token not expired                                        â”‚
â”‚ 4. Extract claims (username, role, etc)                          â”‚
â”‚ File: backend/app/core/security.py â†’ verify_token()              â”‚
â”‚ File: backend/app/core/deps.py â†’ get_current_user()             â”‚
â”‚ 5. If invalid/expired: raise HTTPException(401)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Execute endpoint with verified user                     â”‚
â”‚ The route handler receives: current_user = User object           â”‚
â”‚ Can now return user-specific data                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What Happens When Token Expires

```
Token expires after 1 hour (configurable)
         â†“
Frontend makes API call with expired token
         â†“
Backend returns 401 Unauthorized
         â†“
Frontend interceptor catches 401
(File: frontend/lib/api.ts â†’ axios error handler)
         â†“
Frontend calls POST /api/auth/refresh with refresh token
         â†“
Backend issues new access token
         â†“
Frontend retries original request with new token
         â†“
Success!
```

---

## ğŸ‘¥ CANDIDATE LIFECYCLE (Complete)

### Creating a Candidate with OCR Document Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "New Candidate" button    â”‚
â”‚ Opens: /candidates/create             â”‚
â”‚ File: frontend/app/(dashboard)/       â”‚
â”‚        candidates/create/page.tsx     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User fills form (name, email, phone, etc)                   â”‚
â”‚ Form Component:                                              â”‚
â”‚ File: frontend/components/candidates/candidate-form.tsx     â”‚
â”‚ State: useState() or Zustand store                          â”‚
â”‚ Validation: Zod schema on form                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User uploads resume/rirekisho (JPG, PNG, PDF)               â”‚
â”‚ 1. User selects file from file input                         â”‚
â”‚ 2. Frontend validates: file size < 4MB, type in whitelist   â”‚
â”‚ 3. Creates FormData with file + candidate data              â”‚
â”‚ POST /api/candidates/ with FormData                         â”‚
â”‚ File: frontend/lib/api.ts â†’ multipart/form-data             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Receives FormData                                  â”‚
â”‚ File: backend/app/api/candidates.py â†’                       â”‚
â”‚       @router.post("/")                                      â”‚
â”‚ 1. Validate candidate data with CandidateCreate schema      â”‚
â”‚ 2. Save file to disk: /backend/uploads/[candidate_id]/      â”‚
â”‚ 3. Create candidate record in database                      â”‚
â”‚    INSERT INTO candidates (name, email, ...) VALUES (...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Process OCR" button                             â”‚
â”‚ Sends file to OCR processing                               â”‚
â”‚ POST /api/azure_ocr/extract                                â”‚
â”‚ Body: { "candidate_id": 123, "document_type": "resume" }   â”‚
â”‚ File: backend/app/api/azure_ocr.py                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OCR CASCADE PROCESSING:                                     â”‚
â”‚                                                              â”‚
â”‚ 1ï¸âƒ£ TRY AZURE (Primary)                                      â”‚
â”‚    File: backend/app/services/hybrid_ocr.py                â”‚
â”‚    - Read file from disk                                   â”‚
â”‚    - Send to Azure Computer Vision API                     â”‚
â”‚    - Parse response: extract text, tables, handwriting    â”‚
â”‚    - If success â†’ DONE! Store results                     â”‚
â”‚    - If fails (API error, invalid key, etc):             â”‚
â”‚      â†“                                                       â”‚
â”‚ 2ï¸âƒ£ TRY EASYOCR (Secondary)                                  â”‚
â”‚    - Load EasyOCR model                                    â”‚
â”‚    - Process image file                                   â”‚
â”‚    - If success â†’ DONE! Store results                     â”‚
â”‚    - If fails (no GPU, memory issues, etc):               â”‚
â”‚      â†“                                                       â”‚
â”‚ 3ï¸âƒ£ TRY TESSERACT (Fallback)                               â”‚
â”‚    - Call Tesseract binary                                â”‚
â”‚    - Process image file                                   â”‚
â”‚    - If success â†’ DONE! Store results                     â”‚
â”‚    - If fails â†’ Return error to user                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Extract Data from OCR Results                       â”‚
â”‚ File: backend/app/services/ocr_parser.py                    â”‚
â”‚ 1. Parse raw OCR text                                        â”‚
â”‚ 2. Extract structured data:                                  â”‚
â”‚    - Full name (Kanji + Roman)                              â”‚
â”‚    - Date of birth                                           â”‚
â”‚    - Contact information                                     â”‚
â”‚    - Work history                                            â”‚
â”‚    - Education                                               â”‚
â”‚    - Qualifications                                          â”‚
â”‚ 3. Validate extracted data                                   â”‚
â”‚ 4. Store in documents table with extracted_data JSON        â”‚
â”‚ 5. Also store photo (face detection via MediaPipe)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Return OCR Results to Frontend                      â”‚
â”‚ Response JSON:                                               â”‚
â”‚ {                                                            â”‚
â”‚   "status": "success",                                       â”‚
â”‚   "document_id": 456,                                        â”‚
â”‚   "extracted_data": {                                        â”‚
â”‚     "full_name": "ç”°ä¸­å¤ªéƒ",                                 â”‚
â”‚     "date_of_birth": "1990-05-15",                          â”‚
â”‚     "email": "tanaka@example.com",                          â”‚
â”‚     "phone": "090-1234-5678",                               â”‚
â”‚     "education": [...],                                      â”‚
â”‚     "work_history": [...],                                  â”‚
â”‚     "photo_data_url": "data:image/jpeg;base64,..."         â”‚
â”‚   },                                                         â”‚
â”‚   "confidence": 0.95                                         â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Display OCR Results                                â”‚
â”‚ 1. Show extracted data in form fields                        â”‚
â”‚ 2. User can edit/correct if needed                          â”‚
â”‚ 3. Show confidence score                                     â”‚
â”‚ 4. Display extracted photo                                   â”‚
â”‚ File: frontend/components/candidates/ocr-processor.tsx      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Save Candidate"                                â”‚
â”‚ 1. Validate all required fields                             â”‚
â”‚ 2. POST /api/candidates/{id} with updated data             â”‚
â”‚ 3. Backend updates candidates table                         â”‚
â”‚ 4. Frontend redirects to candidate view                     â”‚
â”‚ 5. Candidate now in system!                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘” EMPLOYEE ASSIGNMENT FLOW (Complete)

### Assigning a Candidate as Employee â†’ Factory â†’ Apartment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User goes to Candidates list                                â”‚
â”‚ Finds candidate to hire                                      â”‚
â”‚ Clicks "Convert to Employee"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend opens assignment form                              â”‚
â”‚ File: frontend/components/employees/assignment-form.tsx    â”‚
â”‚ Form fields:                                                 â”‚
â”‚ - Select factory (æ´¾é£å…ˆ)                                   â”‚
â”‚ - Select apartment/housing (ä½å±…)                           â”‚
â”‚ - Start date                                                 â”‚
â”‚ - Expected end date                                          â”‚
â”‚ - Salary/hourly rate                                         â”‚
â”‚ - Role/position                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User selects factory                                        â”‚
â”‚ GET /api/factories/ returns list                            â”‚
â”‚ File: backend/app/api/factories.py                          â”‚
â”‚ Database query:                                              â”‚
â”‚ SELECT * FROM factories WHERE active=true                  â”‚
â”‚ Response: [{ id: 1, name: "Factory A", ... }, ...]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User selects apartment/housing                              â”‚
â”‚ GET /api/apartments/?available=true                         â”‚
â”‚ File: backend/app/api/apartments.py                         â”‚
â”‚ Database query:                                              â”‚
â”‚ SELECT * FROM apartments                                    â”‚
â”‚ WHERE available=true AND capacity > current_occupancy      â”‚
â”‚ Response: [{ id: 10, address: "...", capacity: 4, ... }]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User submits form                                           â”‚
â”‚ POST /api/employees/                                        â”‚
â”‚ Body:                                                        â”‚
â”‚ {                                                            â”‚
â”‚   "rirekisho_id": 123,       â† Candidate ID                â”‚
â”‚   "factory_id": 1,            â† Selected factory            â”‚
â”‚   "apartment_id": 10,         â† Selected apartment          â”‚
â”‚   "start_date": "2025-01-01",                              â”‚
â”‚   "salary": 250000,                                         â”‚
â”‚   "role": "Manufacturing worker"                           â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Validate assignment                                â”‚
â”‚ File: backend/app/api/employees.py â†’                        â”‚
â”‚       @router.post("/")                                      â”‚
â”‚ Checks:                                                      â”‚
â”‚ 1. Candidate exists? SELECT * FROM candidates WHERE id=123 â”‚
â”‚ 2. Factory exists? SELECT * FROM factories WHERE id=1      â”‚
â”‚ 3. Apartment exists? SELECT * FROM apartments WHERE id=10  â”‚
â”‚ 4. Apartment has capacity? occupancy < capacity             â”‚
â”‚ 5. No conflicts? Not already assigned elsewhere             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Create employee record                             â”‚
â”‚ File: backend/app/services/employee_service.py             â”‚
â”‚ 1. INSERT INTO employees (                                  â”‚
â”‚      rirekisho_id, factory_id, apartment_id,              â”‚
â”‚      start_date, salary, status                            â”‚
â”‚    ) VALUES (123, 1, 10, '2025-01-01', 250000, 'active') â”‚
â”‚ 2. UPDATE apartments SET                                    â”‚
â”‚      current_occupancy = current_occupancy + 1             â”‚
â”‚    WHERE id = 10                                            â”‚
â”‚ 3. INSERT INTO audit_log (records who made change)         â”‚
â”‚ 4. Return created employee record to frontend              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Success!                                          â”‚
â”‚ 1. Receive employee object with ID                         â”‚
â”‚ 2. Update Zustand store                                     â”‚
â”‚ 3. Redirect to employee view page                          â”‚
â”‚ 4. Show confirmation message                               â”‚
â”‚ File: frontend/app/(dashboard)/employees/[id]/page.tsx   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š PAYROLL CALCULATION FLOW (Complete)

### Monthly Payroll: Hours â†’ Salary â†’ Taxes â†’ Take-home

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Manager goes to Payroll page                               â”‚
â”‚ Selects month (e.g., October 2024)                         â”‚
â”‚ Clicks "Calculate Payroll"                                  â”‚
â”‚ File: frontend/app/(dashboard)/payroll/page.tsx           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/payroll/calculate                                 â”‚
â”‚ Body: { "month": "2024-10" }                               â”‚
â”‚ File: backend/app/api/payroll.py                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Fetch all active employees                         â”‚
â”‚ SELECT * FROM employees WHERE status='active'               â”‚
â”‚ For each employee: fetch their timer cards for that month   â”‚
â”‚ SELECT * FROM timer_cards                                  â”‚
â”‚ WHERE employee_id=X AND month='2024-10'                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Calculate hours worked                             â”‚
â”‚ For each timer_card:                                        â”‚
â”‚ 1. Calculate: check_out_time - check_in_time               â”‚
â”‚ 2. Subtract breaks                                          â”‚
â”‚ 3. Handle late shifts (after 22:00) â†’ overtime 1.25x      â”‚
â”‚ 4. Handle night shifts (before 06:00) â†’ overtime 1.25x    â”‚
â”‚ 5. Total = regular_hours + (overtime_hours * 1.25)        â”‚
â”‚                                                              â”‚
â”‚ File: backend/app/services/payroll_service.py              â”‚
â”‚        â†’ calculate_hours_worked()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Calculate gross salary                             â”‚
â”‚ 1. Get hourly_rate from employee record                     â”‚
â”‚ 2. Gross = total_hours * hourly_rate                        â”‚
â”‚ 3. Example:                                                  â”‚
â”‚    - Hourly rate: 1,500 yen                                â”‚
â”‚    - Regular hours: 160                                     â”‚
â”‚    - Overtime hours: 10                                     â”‚
â”‚    - Calculation:                                           â”‚
â”‚      Regular: 160 * 1,500 = 240,000                        â”‚
â”‚      Overtime: 10 * 1,500 * 1.25 = 18,750                 â”‚
â”‚      Gross: 240,000 + 18,750 = 258,750                    â”‚
â”‚                                                              â”‚
â”‚ File: backend/app/services/payroll_service.py              â”‚
â”‚        â†’ calculate_gross_salary()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Calculate deductions                               â”‚
â”‚ 1. Health Insurance (å¥åº·ä¿é™º)                              â”‚
â”‚    Calculation: gross * 0.05 = 258,750 * 0.05 = 12,937   â”‚
â”‚ 2. Pension (åšç”Ÿå¹´é‡‘)                                       â”‚
â”‚    Calculation: gross * 0.092 = 258,750 * 0.092 = 23,805  â”‚
â”‚ 3. Unemployment Insurance (é›‡ç”¨ä¿é™º)                         â”‚
â”‚    Calculation: gross * 0.003 = 258,750 * 0.003 = 776     â”‚
â”‚ 4. Income Tax (æ‰€å¾—ç¨)                                      â”‚
â”‚    Rate depends on gross salary bracket:                    â”‚
â”‚    If gross < 270,000: tax = 0                             â”‚
â”‚    If 270,000 â‰¤ gross < 500,000: tax = (gross - 270,000) * 0.1
â”‚    If gross â‰¥ 500,000: tax = (gross - 500,000) * 0.2 + 23,000
â”‚    For this example: 0 (under threshold)                   â”‚
â”‚ 5. Social Insurance deduction (ç¤¾ä¼šä¿é™ºæ–™)                  â”‚
â”‚    Already included above, but also includes employer share â”‚
â”‚ 6. Total Deductions = 12,937 + 23,805 + 776 = 37,518      â”‚
â”‚                                                              â”‚
â”‚ File: backend/app/services/payroll_service.py              â”‚
â”‚        â†’ calculate_deductions()                             â”‚
â”‚        â†’ calculate_income_tax()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Calculate net salary (take-home)                   â”‚
â”‚ Net = Gross - Total Deductions                              â”‚
â”‚ Net = 258,750 - 37,518 = 221,232 yen                       â”‚
â”‚                                                              â”‚
â”‚ Final breakdown:                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚ â”‚ Gross Salary  258,750   â”‚                                â”‚
â”‚ â”‚ -Health Ins    12,937   â”‚                                â”‚
â”‚ â”‚ -Pension       23,805   â”‚                                â”‚
â”‚ â”‚ -Unemploy.        776   â”‚                                â”‚
â”‚ â”‚ -Income Tax         0   â”‚                                â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                â”‚
â”‚ â”‚ Net Salary    221,232   â”‚                                â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                              â”‚
â”‚ File: backend/app/services/payroll_service.py              â”‚
â”‚        â†’ calculate_net_salary()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Save to database                                   â”‚
â”‚ INSERT INTO salary_calculations (                            â”‚
â”‚   employee_id, month, year,                                â”‚
â”‚   total_hours, regular_hours, overtime_hours,              â”‚
â”‚   hourly_rate, gross_salary,                               â”‚
â”‚   health_insurance, pension, unemployment_insurance,        â”‚
â”‚   income_tax, total_deductions, net_salary,                â”‚
â”‚   status, calculated_at                                     â”‚
â”‚ ) VALUES (...)                                              â”‚
â”‚                                                              â”‚
â”‚ File: backend/app/models/models.py â†’                        â”‚
â”‚       SalaryCalculation table                               â”‚
â”‚                                                              â”‚
â”‚ status = 'pending' (awaiting approval)                      â”‚
â”‚ status can change to: 'approved' â†’ 'paid'                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Return results to frontend                         â”‚
â”‚ Response: Payroll summary by employee                       â”‚
â”‚ File: backend/app/api/payroll.py                           â”‚
â”‚ Returns: [                                                  â”‚
â”‚   {                                                         â”‚
â”‚     "employee_id": 1,                                       â”‚
â”‚     "employee_name": "ç”°ä¸­å¤ªéƒ",                             â”‚
â”‚     "month": "2024-10",                                     â”‚
â”‚     "gross_salary": 258750,                                â”‚
â”‚     "total_deductions": 37518,                             â”‚
â”‚     "net_salary": 221232,                                  â”‚
â”‚     "status": "pending"                                    â”‚
â”‚   },                                                        â”‚
â”‚   ...                                                       â”‚
â”‚ ]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND: Display payroll summary                           â”‚
â”‚ 1. Show table with all employees                           â”‚
â”‚ 2. Show gross, deductions, net for each                    â”‚
â”‚ 3. Show total company payout                               â”‚
â”‚ 4. Show "Approve" button                                   â”‚
â”‚ File: frontend/components/payroll/payroll-summary.tsx      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Manager reviews and approves                               â”‚
â”‚ Clicks "Approve & Generate Bank Transfer"                 â”‚
â”‚ PATCH /api/payroll/{salary_id}/approve                     â”‚
â”‚ File: backend/app/api/payroll.py                           â”‚
â”‚ 1. Update status to 'approved'                             â”‚
â”‚ 2. Generate PDF report                                      â”‚
â”‚ 3. Generate bank transfer CSV (for accounting software)    â”‚
â”‚ 4. Return PDF and CSV to download                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend marks as "paid"                                     â”‚
â”‚ UPDATE salary_calculations SET status='paid'               â”‚
â”‚ File sent to accounting/bank for processing                â”‚
â”‚ Done!                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tax Calculation Example (Japanese)

```
Monthly Gross Salary: 258,750 yen

Social Insurance Contributions (employee portion):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Health Insurance (å¥åº·ä¿é™º): ~5%
   258,750 Ã— 0.049 = 12,678 yen

2. Nursing Care Insurance (ä»‹è­·ä¿é™º): ~1%
   258,750 Ã— 0.011 = 2,846 yen

3. Pension (åšç”Ÿå¹´é‡‘): ~9.2%
   258,750 Ã— 0.092 = 23,805 yen

4. Unemployment Insurance (é›‡ç”¨ä¿é™º): ~0.3%
   258,750 Ã— 0.003 = 776 yen

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total Social Insurance: 40,105 yen
Net before income tax: 218,645 yen

Income Tax (æ‰€å¾—ç¨):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Depends on annual total. If under 1,030,000 for year:
No income tax withholding

Final Net Salary: ~218,645 yen (varies by tax treaty)

Files:
- backend/app/services/tax_calculator.py (if exists)
- backend/app/services/payroll_service.py (calculate_income_tax)
```

---

## ğŸ“‹ ATTENDANCE TRACKING FLOW (Time Card / ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰)

### Employee Check-in â†’ Check-out â†’ Hours Recorded

```
Employee arrives at factory
         â†“
Opens app on mobile/web
         â†“
Goes to Timer Card page
File: frontend/app/(dashboard)/timercards/page.tsx
         â†“
Clicks "Check In" button
         â†“
Frontend sends: POST /api/timer_cards/checkin
Body: { "employee_id": 1, "location_id": 5 }
File: backend/app/api/timer_cards.py
         â†“
Backend creates record:
INSERT INTO timer_cards (
  employee_id, date, check_in_time, location_id
) VALUES (1, '2024-10-15', '09:00:00', 5)
         â†“
Frontend shows: "Checked in at 09:00"
         â†“
[Employee works all day]
         â†“
Employee leaves factory
         â†“
Clicks "Check Out" button
         â†“
Frontend sends: POST /api/timer_cards/checkout
Body: { "timer_card_id": 789 }
         â†“
Backend updates record:
UPDATE timer_cards SET check_out_time='17:30:00'
WHERE id=789
         â†“
Backend calculates: 17:30 - 09:00 = 8 hours 30 minutes
         â†“
Deducts break time: 8 hours 30 minutes - 1 hour = 7 hours 30 minutes
         â†“
Frontend shows: "Checked out. Total: 7.5 hours"
         â†“
At end of month:
Payroll service fetches all timer_cards for that month
Sums up all hours per employee
Uses for salary calculation (see PAYROLL FLOW above)
```

---

## ğŸ”„ REQUEST/LEAVE FLOW (ç”³è«‹ - Applications)

### Employee Requests Leave â†’ Manager Approves â†’ Status Updated

```
Employee wants to take vacation
         â†“
Goes to Requests page
File: frontend/app/(dashboard)/requests/page.tsx
         â†“
Clicks "New Request" â†’ "Vacation"
         â†“
Fills form:
- Type: Vacation (å¹´ä¼‘/Nenko) or Personal leave (æœ‰çµ¦)
- Start date: 2024-11-20
- End date: 2024-11-22
- Reason: "Family visit"
         â†“
Clicks "Submit"
         â†“
Frontend: POST /api/requests/
Body: {
  "employee_id": 1,
  "request_type": "vacation",
  "start_date": "2024-11-20",
  "end_date": "2024-11-22",
  "reason": "Family visit"
}
File: backend/app/api/requests.py
         â†“
Backend creates request:
INSERT INTO requests (
  employee_id, type, start_date, end_date, reason, status
) VALUES (1, 'vacation', '2024-11-20', '2024-11-22', 'Family visit', 'pending')
         â†“
Backend checks: Does employee have enough vacation days?
SELECT vacation_days_available FROM employees WHERE id=1
If: 3 days requested, 4 available â†’ OK
If: 3 days requested, 2 available â†’ Error
         â†“
Manager notification sent (email/LINE API if configured)
File: backend/app/services/notification_service.py
         â†“
Manager sees pending request
File: frontend/app/(dashboard)/requests/page.tsx
         â†“
Manager clicks "Approve"
         â†“
Frontend: PATCH /api/requests/{id}/approve
         â†“
Backend:
UPDATE requests SET status='approved' WHERE id=X
UPDATE employees SET vacation_days_available = 4 - 3 = 1
         â†“
Employee sees: "Your leave request approved"
Status changed in their dashboard
         â†“
On leave dates:
Employee cannot check in (blocked by system)
Manager sees employee as "on leave"
Payroll excludes these days from calculation
         â†“
Employee returns:
Can check in again normally
```

---

## ğŸ  HOUSING ASSIGNMENT FLOW (Apartment Management)

### Apartment Availability â†’ Employee Assignment â†’ Occupancy Tracking

```
Company has apartments for employees
         â†“
Admin goes to Housing/Apartments page
File: frontend/app/(dashboard)/apartments/page.tsx
         â†“
Sees list of apartments:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apartment A              â”‚
â”‚ Capacity: 4              â”‚
â”‚ Current Occupancy: 2     â”‚
â”‚ Available Rooms: 2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
Employee assigned to this apartment (see EMPLOYEE ASSIGNMENT FLOW)
         â†“
Backend automatically:
UPDATE apartments SET current_occupancy = 3 WHERE id=1
         â†“
If occupancy reaches capacity (4/4):
System marks as "full"
New employee assignments show only available apartments
         â†“
When employee terminates (status='terminated'):
Backend automatically:
UPDATE apartments SET current_occupancy = 3 WHERE id=1
         â†“
Apartment becomes available again for next employee
```

---

## ğŸ”— DATA RELATIONSHIPS (How tables connect)

```
users (staff/admins)
  â”œâ”€ can create â†’ candidates
  â”œâ”€ can create â†’ employees
  â”œâ”€ can create â†’ factories
  â””â”€ audit_log records all actions

candidates (job applicants with å±¥æ­´æ›¸)
  â”œâ”€ have documents (uploaded resumes with OCR data)
  â”œâ”€ can become â†’ employees
  â””â”€ identified by rirekisho_id

employees (active workers)
  â”œâ”€ belong to â†’ factories (where they work)
  â”œâ”€ assigned to â†’ apartments (where they live)
  â”œâ”€ have timer_cards (attendance records)
  â”œâ”€ have salary_calculations (monthly payroll)
  â”œâ”€ can make â†’ requests (leave, etc)
  â””â”€ identified by rirekisho_id (links to original candidate)

factories (æ´¾é£å…ˆ - client sites)
  â””â”€ have employees working there

apartments (housing)
  â””â”€ have employees living there

documents (uploaded files)
  â”œâ”€ belong to candidates
  â”œâ”€ contain OCR extracted data
  â””â”€ store original file + parsed JSON

timer_cards (attendance/ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰)
  â”œâ”€ belong to employees
  â”œâ”€ recorded daily
  â””â”€ used for payroll calculation

salary_calculations (payroll/çµ¦ä¸)
  â”œâ”€ belong to employees
  â”œâ”€ calculated monthly
  â”œâ”€ include gross, deductions, net
  â””â”€ can be approved/paid/rejected

requests (ç”³è«‹)
  â”œâ”€ belong to employees
  â”œâ”€ types: vacation, personal leave, etc
  â”œâ”€ status: pending â†’ approved/rejected
  â””â”€ affect available vacation days

contracts (employment contracts)
  â”œâ”€ belong to employees
  â”œâ”€ define terms
  â””â”€ can expire/auto-renew
```

---

## âš ï¸ CRITICAL OPERATIONS

### Things That Trigger Cascading Changes

**When Employee Status Changes:**
```
Employee status: active â†’ terminated
         â†“
1. Stop accepting timer cards
2. Calculate final payroll
3. Release apartment (decrement occupancy)
4. Mark contracts as ended
5. Archive all related records
6. Audit log entry created
```

**When Employee is Deleted:**
```
DELETE FROM employees WHERE id=X
         â†“
Triggers ON DELETE CASCADE:
- Delete all timer_cards
- Delete all salary_calculations
- Delete all requests
- Decrement apartment occupancy
- Update audit_log
```

**When Database Connection Lost:**
```
Backend â†” Frontend connection drops
         â†“
Frontend detects 5xx error
         â†“
Retry with exponential backoff
         â†“
If 3 retries fail: Show "Connection Lost" message
         â†“
User asked to refresh page
```

---

**For AI Agents**: Use these flows to understand context when fixing bugs!

